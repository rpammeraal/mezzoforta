<html>
<head>
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link href="stylesheet.css" rel="stylesheet">
</head>

<body>

    <div class="container">
        <div id="logo"></div>
        <div id="menu">
            <div class="menu-item" context="playlist_list">
                <img src="/images/PlaylistIcon.png" alt="Playlists">
                <p>Playlists</p>
            </div>

            <div class="menu-item">
                <img src="/images/NoBandPhoto.png" alt="Performers">
                <p>Performers</p>
            </div>

            <div class="menu-item" context="album_list">
                <img src="/images/NoAlbumCover.png" alt="Albums">
                <p>Albums</p>
            </div>

            <div class="menu-item" context="song_list">
                <img src="/images/SongIcon.png" alt="Songs">
                <p>Songs</p>
            </div>

            <div class="menu-item">
                <img src="/images/ChartIcon.png" alt="Charts">
                <p>Charts</p>
            </div>
      </div>
      <div id="alphabet">
            <div class="alphabet-item"><p>A</p></div>
            <div class="alphabet-item"><p>B</p></div>
            <div class="alphabet-item"><p>C</p></div>
            <div class="alphabet-item"><p>D</p></div>
            <div class="alphabet-item"><p>E</p></div>
            <div class="alphabet-item"><p>F</p></div>
            <div class="alphabet-item"><p>G</p></div>
            <div class="alphabet-item"><p>H</p></div>
            <div class="alphabet-item"><p>I</p></div>
            <div class="alphabet-item"><p>J</p></div>
            <div class="alphabet-item"><p>K</p></div>
            <div class="alphabet-item"><p>L</p></div>
            <div class="alphabet-item"><p>M</p></div>
            <div class="alphabet-item"><p>N</p></div>
            <div class="alphabet-item"><p>O</p></div>
            <div class="alphabet-item"><p>P</p></div>
            <div class="alphabet-item"><p>Q</p></div>
            <div class="alphabet-item"><p>R</p></div>
            <div class="alphabet-item"><p>S</p></div>
            <div class="alphabet-item"><p>T</p></div>
            <div class="alphabet-item"><p>U</p></div>
            <div class="alphabet-item"><p>V</p></div>
            <div class="alphabet-item"><p>W</p></div>
            <div class="alphabet-item"><p>X</p></div>
            <div class="alphabet-item"><p>Y</p></div>
            <div class="alphabet-item"><p>Z</p></div>
            <div class="alphabet-item"><p>*</p></div>
        </div>
        <div id="output">
            <TABLE cols="3">
                <TBODY>
                    <TR>
                        <TD><DIV id="output_header">output_header</DIV></TD>
                        <TD><DIV id="sb_context_play_button" onclick="control_player('play');"><BUTTON>&gt;</BUTTON></DIV></TD>
                        <TD><DIV id="sb_paging_prev_button" onclick="pager(null,null,'prev');"><BUTTON>Prev</BUTTON></DIV></TD>
                        <TD><DIV id="sb_paging_next_button" onclick="pager(null,null,'next');"><BUTTON>Next</BUTTON></DIV></TD>
                    </TR>
                    <TR>
                        <TD colspan="3"><div id="output_content">output_content</div></TD>
                    </TR>
                </TBODY>
            </TABLE>
        </div>
        <div id="playerstatus"></div>
        <div id="playercontrol">
            <div class="playercontrol_button" id="<<" onclick="control_player('prev')"><button>&lt;&lt;</button></div>
            <div class="playercontrol_button" id="[]" onclick="control_player('stop')"><button>[]</button></div>      
            <div class="playercontrol_button" id=">"  onclick="control_player('play')"><button>&gt;</button></div>     
            <div class="playercontrol_button" id=">>" onclick="control_player('next')"><button>&gt;&gt;</button></div>
        </div>
    </div>

	<script>
		// Wait till DOM is loaded //
		document.addEventListener("DOMContentLoaded", function() {
			document.body.style.transition = "opacity 1.5s ease";
			document.body.style.opacity = 1;
		});

		function statusInterval() {
			setInterval(StatusUpdate, 2000);
		}
		
		statusInterval();

		var StatusTemp = null;
		var StatusURL = "/status.html";
        var pager_offset=0;
        const pager_size=100;
        var pager_letter=null;
        var current_key=null;

		function StatusUpdate() {
			var xhr = new XMLHttpRequest();
			var url = StatusURL + "?_=" + new Date().getTime();
			
			xhr.onreadystatechange = function() {
				if (xhr.readyState == 4 && xhr.status == 200) {
					var Content = xhr.responseText.trim();
					if (StatusTemp !== Content) {
					    var Element = document.getElementById("playerstatus");
						StatusTemp = Content;
						Element.innerHTML = Content;
					}
				}
			};
			
			xhr.open("GET", url, true);
			xhr.send();
		}

		StatusUpdate();

		const loc = window.location.href + '/';
        context = 'menu';

        console.log(context);

        function sb_key_to_context() {
            const p_key=arguments[0];
            const args=p_key.split(':');
            const sb_type=args[0];
            const sb_id=args[1];
            const r_context='menu';

            console.log('sb_key_to_context:sb_type',sb_type);
            switch(parseInt(sb_type)) {
                case 1:
                    return 'song_detail';
                    break;

                case 2:
                    return 'performer_detail';
                    break;

                case 3:
                    return 'album_detail';
                    break;

                case 4:
                    return 'chart_detail';
                    break;

                case 5:
                    return 'playlist_detail';
                    break;

            }
            console.log('ERROR: sb_type not handled:',sb_type);
            return 'menu';
        }


        function get_hrt() {
            p_context=arguments[0];
            switch(p_context) {
                case 'album_detail':
                    return 'Album: ';
                    break;

                case 'album_list':
                    return 'List of Albums: ';
                    break;

                case 'playlist_detail':
                    return 'Playlist: ';
                    break;

                case 'playlist_list':
                    return 'Playlists: ';
                    break;

                case 'song_detail':
                    return 'Song: ';
                    break;

                case 'song_list':
                    return 'List of Songs: ';
                    break;

            }
            console.log("retrieve_url: p_context not handled", p_context);
            return '';
        }

        function retrieve_url() {
            p_context=arguments[0];
            url='';
            console.log(p_context);
            switch(p_context) {
                case 'album_detail':
                    console.log("handle album_detail");
                    return '/album_detail.html'
                    break;

                case 'album_list':
                    console.log("handle album_list");
                    return '/album_list.html'
                    break;

                case 'playlist_detail':
                    console.log("handle playlist_detail");
                    return '/playlist_detail.html'
                    break;

                case 'playlist_list':
                    console.log("handle playlist_list");
                    return '/playlist_list.html'
                    break;

                case 'song_detail':
                    console.log("handle song_detail");
                    return '/song_detail.html'
                    break;

                case 'song_list':
                    console.log("handle song_list");
                    return '/song_list.html'
                    break;
            }
            console.log("retrieve_url: p_context not handled", p_context);
            return '';
        }

        function set_screen() {
            p_context=arguments[0];
            p_key=arguments[1];

            console.log("Switch from",context,"to",p_context);
            alphabet_visible_toggle='hidden';
            menu_visible_toggle='hidden';
            output_visible_toggle='hidden';

            pager_prev_button_toggle='hidden';
            pager_next_button_toggle='hidden';
            sb_context_play_button_toggle='hidden';

            switch(p_context) {
                case 'album_detail': 
                    alphabet_visible_toggle='hidden';
                    menu_visible_toggle='hidden';
                    output_visible_toggle='visible';
                    pager_prev_button_toggle='hidden';
                    pager_next_button_toggle='hidden';
                    current_key=p_key;
                    sb_context_play_button_toggle='visible';
                    break;

                case 'album_list': 
                    alphabet_visible_toggle='visible';
                    menu_visible_toggle='hidden';
                    output_visible_toggle='visible';
                    pager_prev_button_toggle='visible';
                    pager_next_button_toggle='visible';
                    current_key=null;
                    sb_context_play_button_toggle='hidden';
                    break;

                case 'menu':
                    alphabet_visible_toggle='hidden';
                    menu_visible_toggle='visible';
                    output_visible_toggle='hidden';
                    pager_prev_button_toggle='hidden';
                    pager_next_button_toggle='hidden';
                    current_key=null;
                    sb_context_play_button_toggle='hidden';
                    break;

                case 'playlist_detail': 
                    alphabet_visible_toggle='hidden';
                    menu_visible_toggle='hidden';
                    output_visible_toggle='visible';
                    pager_prev_button_toggle='hidden';
                    pager_next_button_toggle='hidden';
                    current_key=p_key;
                    sb_context_play_button_toggle='visible';
                    break;

                case 'playlist_list':
                    alphabet_visible_toggle='hidden';
                    menu_visible_toggle='hidden';
                    output_visible_toggle='visible';
                    pager_prev_button_toggle='hidden';
                    pager_next_button_toggle='hidden';
                    current_key=null;
                    sb_context_play_button_toggle='hidden';
                    break;

                case 'song_detail': 
                    alphabet_visible_toggle='hidden';
                    menu_visible_toggle='hidden';
                    output_visible_toggle='visible';
                    pager_prev_button_toggle='hidden';
                    pager_next_button_toggle='hidden';
                    sb_context_play_button_toggle='visible';
                    current_key=p_key;
                    break;

                case 'song_list': 
                    alphabet_visible_toggle='visible';
                    menu_visible_toggle='hidden';
                    output_visible_toggle='visible';
                    pager_prev_button_toggle='visible';
                    pager_next_button_toggle='visible';
                    current_key=null;
                    sb_context_play_button_toggle='hidden';
                    break;
            }
            const alphabet_div = document.getElementById('alphabet'); 
            console.log("Set visibility on alphabet_div to",alphabet_visible_toggle);
            alphabet_div.style.visibility = alphabet_visible_toggle;

            const menu_div = document.getElementById('menu'); 
            console.log("Set visibility on menu_div to",menu_visible_toggle);
            menu_div.style.visibility = menu_visible_toggle;

            const output_div = document.getElementById('output'); 
            console.log("Set visibility on output_div to",output_visible_toggle);
            output_div.style.visibility = output_visible_toggle;

            if(output_visible_toggle=='visible') {
                const output_content_div = document.getElementById('output_content'); 
                output_content_div.scrollTo(0,0);
                output_content.scrollTo(0,0);
            }

            const pager_prev_button_div = document.getElementById('sb_paging_prev_button'); 
            console.log("Set visibility on pager_prev_button_div to",pager_prev_button_toggle);
            pager_prev_button_div.style.visibility = pager_prev_button_toggle;

            const pager_next_button_div = document.getElementById('sb_paging_next_button'); 
            console.log("Set visibility on pager_next_button_div to",pager_next_button_toggle);
            pager_next_button_div.style.visibility = pager_next_button_toggle;

            const sb_context_play_button_div = document.getElementById('sb_context_play_button'); 
            console.log("Set visibility on sb_context_play_button_div to",sb_context_play_button_toggle);
            sb_context_play_button_div.style.visibility = sb_context_play_button_toggle;

            context=p_context;
        }

        function control_player() {
            const xhr = new XMLHttpRequest();
            const url="/player/play?action=";
            const p_action=arguments[0];
            const p_key=arguments[1];

            console.log("# player_control()");
            console.log("p_key",p_key);
            console.log("current_key",current_key);

            var required_key=p_key;
            if(required_key==null) {
                required_key=current_key;
            }
            console.log("required_key",required_key);

            const request=url.concat(p_action,'&key=',required_key);
            console.log("request",request);

			fetch(request)
				.then(response => {
					if (!response.ok) {
						throw new Error('4 oh n0 4: ' + response.statusText);
					}
					return response.text();
				})
				.then(data => {

				})
				.catch(error => {
					console.error(error);
				});
		}
		
        history.pushState(null, document.title, location.href);
        window.addEventListener('popstate', function (event) {
            history.pushState(null, document.title, location.href);
        });

		// Menu-Items ->> Output
		document.addEventListener('DOMContentLoaded', function () {
			const logo = document.getElementById('logo');
			const menu = document.getElementById('menu');
			const menuOutput = document.getElementById('output');

			logo.addEventListener('click', function () {
				// Toggle the classes to control visibility
				menuOutput.classList.remove('show');
				menu.classList.remove('hide');
                set_screen("menu",null);

			});

			const menuItems = document.querySelectorAll('.menu-item');
			const menuOutputContent = document.getElementById('output_content');
			const menuOutputHeader = document.getElementById('output_header');

			menuItems.forEach(function (menuItem) {
				menuItem.addEventListener('click', function () {

					// Use the text of a Menu-Item in the Paragraph
					const menuItemText = this.querySelector('p').innerText;

					// Use the name from the Paragraph and append .html
                    const new_context = this.getAttribute('context');
                    console.log(new_context);
                    const url=retrieve_url(new_context);
                    console.log(url)
            
                    console.log('###########');
                    console.log('menuItemText',menuItemText);

					menuOutputHeader.innerText = menuItemText;
                    pager(new_context,'A',null);
				});
			});

			const alphabetItems = document.querySelectorAll('.alphabet-item');
			alphabetItems.forEach(function (alphabetItem) {
				alphabetItem.addEventListener('click', function () {

					const first_letter = this.querySelector('p').innerText;
                    pager(null,first_letter,'zoo');

				});
			});
		});

        function pager() {
            console.log("### pager()");
            var p_context=arguments[0];
            var p_letter=arguments[1];
            var p_action=arguments[2];

            if(p_context==null) {
                p_context=context;
            }

            if(p_letter==null) {
                if(pager_letter==null) {
                    pager_letter='A';
                    pager_offset=0;
                }
                p_letter=pager_letter;
            }

            if(p_letter!=pager_letter)
            {
                pager_offset=0;
                p_offset=0;
                p_action=null;
            }

            if(p_action=='prev')
            {
                pager_offset=pager_offset - pager_size;
            }
            if(p_action=='next')
            {
                pager_offset=pager_offset + pager_size;
            }



			const menuOutputContent = document.getElementById('output_content');
			var menuOutputHeader = document.getElementById('output_header');

            var url=retrieve_url(p_context);
            url=url.concat(`?letter=${p_letter}&offset=${pager_offset}&size=${pager_size}`);

            const xhr = new XMLHttpRequest();
            xhr.onreadystatechange = function () {
                if (xhr.readyState === 4 && xhr.status === 200) {
                    menuOutputContent.innerHTML = xhr.responseText;
                    set_screen(p_context,null);

                    var has_prev=document.getElementById('sb_paging_prev_ind').querySelector('p').innerText;
                    var has_next=document.getElementById('sb_paging_next_ind').querySelector('p').innerText;

                    var prev_button=document.getElementById('sb_paging_prev_button').querySelector('button');
                    if(has_prev==1) {
                        prev_button.disabled=false; 
                    }
                    else {
                        prev_button.disabled=true; 
                    }

                    var next_button=document.getElementById('sb_paging_next_button').querySelector('button');
                    if(has_next==1) {
                        next_button.disabled=false; 
                    }
                    else {
                        next_button.disabled=true; 
                    }
                }
            };

            xhr.open('GET', url, true);
            xhr.send();
            pager_letter=p_letter;
        }

        function open_page() {
            console.log("### open_page()");
            const p_sb_key=arguments[0];
            const p_output_header=arguments[1];   //  output_header contains raw data, e.g. just song title, performer name et al 
            console.log(p_context,p_sb_key);

            p_context=sb_key_to_context(p_sb_key);

            var url=retrieve_url(p_context);
            url=url.concat('?sb_key=',p_sb_key);
            console.log(url);

            var output_header=get_hrt(p_context)
            console.log('output_header',output_header);
            output_header=output_header.concat(p_output_header);

			const menuOutputContent = document.getElementById('output_content');
			const menuOutputHeader = document.getElementById('output_header');
            const xhr = new XMLHttpRequest();
            xhr.onreadystatechange = function () {
                if (xhr.readyState === 4 && xhr.status === 200) {
                    menuOutputContent.innerHTML = xhr.responseText;
                    menuOutputHeader.innerText = output_header;
                    // Toggle the classes to control visibility
                    //menuOutput.classList.add('show');   //  not used
                    menu.classList.add('hide');
                    console.log("Calling set screen with",p_context);

                    set_screen(p_context,p_sb_key);
                }
            };

            xhr.open('GET', url, true);
            xhr.send();
        }
	
        set_screen('menu',null);

        //  NEXT:playbutton next to playlists header need to disappear.
        //  follow logic of sb_paging_next/prev button 

	</script>
</body>
</html>
